<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.6" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.6">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.6" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.6',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Hexo</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
</li>

      

      
    </ul>
  

  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/21/etcd-deploy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Cheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/21/etcd-deploy/" itemprop="url">etcd安装部署步骤</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-21T18:45:24+08:00">2018-04-21</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="etcd安装部署步骤"><a href="#etcd安装部署步骤" class="headerlink" title="etcd安装部署步骤"></a>etcd安装部署步骤</h1><p>我是通过yum直接安装的(<code>yum install etcd -y</code>)，其生成的配置文件在<code>/etc/etcd/etcd.conf</code>。</p>
<p>这里分单机版和集群版来介绍配置项</p>
<h2 id="单机配置"><a href="#单机配置" class="headerlink" title="单机配置"></a>单机配置</h2><p><code>ETCD_DATA_DIR</code>:数据存放路径,默认不用修改，当然也可以存到其他地方；<br><code>ETCD_WAL_DIR</code>:默认为空，设置了路径后，可以用WAL写入替代data文件写入，操作丢失风险更小；<br><code>ETCD_LISTEN_CLIENT_URLS</code>:  告知客户端的URL,因为其曝露了RESTFUL API，用于进行交互，云服务器注意设置为内网ip+2379(默认监听端口)，<strong>不设置的话，其他主机无法访问</strong>；<br><code>ETCD_ADVERTISE_CLIENT_URLS</code>：告知客户端的URL，设置和上一项相同即可；</p>
<h2 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h2><ul>
<li><code>ETCD_INITIAL_ADVERTISE_PEER_URLS</code>:告知集群其他节点的URL,一般是2380端口；</li>
<li><code>ETCD_INITIAL_CLUSTER</code>: 集群的节点信息 比如<code>node1=http://119.29.155.122:2380</code>；</li>
<li><code>ETCD_INITIAL_CLUSTER_TOKEN</code>: 自定义的一个token；</li>
<li><code>ETCD_INITIAL_CLUSTER_STATE</code>: 这里有两种<code>new</code>和<code>existing</code>,即加入与被加入；</li>
</ul>
<p>配置好了之后，就可以用远程客户端或者etcdctl来使用etcd相关功能了。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/11/raft算法简述/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Cheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/11/raft算法简述/" itemprop="url">raft算法简述</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-11T14:34:32+08:00">2018-03-11</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="raft算法简述"><a href="#raft算法简述" class="headerlink" title="raft算法简述"></a>raft算法简述</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文是对raft相关论文以及其他相关文献进行阅读，整理出的raft算法的相关细节</p>
<h2 id="节点结构"><a href="#节点结构" class="headerlink" title="节点结构"></a>节点结构</h2><p>raft算法采用了复制状态机的相关思路。每个节点保存有操作序列以及操作后的数据信息。一般来说，一个节点有3个模块：</p>
<ol>
<li>状态机：保存数据的结果状态</li>
<li>日志：用于同步的数据修改记录</li>
<li>一致性处理模块：用于确保系统内每个节点的日志信息一致性<br><img src="images/FAB6A4A1-F5A1-433C-8BE8-BD9806920AEC.png" alt=""></li>
</ol>
<p>客户端的相关消息发送给服务器，服务器通过相关操作，将结果返回。</p>
<h2 id="关键阶段"><a href="#关键阶段" class="headerlink" title="关键阶段"></a>关键阶段</h2><p>首先确定一致性算法具备的相关特性</p>
<ol>
<li>确保安全性。即使在所有的非拜占庭（即没有故意发送错误信息）的情况下，包括网络延迟、分区、丢包、冗余和乱序的情况下。</li>
<li>高可用性。当集群中的大部分机器可用，整个系统就可以正常使用。</li>
<li>不依赖时序保证一致性，时钟错误和极端情况下的消息延迟在最坏的情况下才会引起可用性问题。</li>
<li>通常情况下，一条命令能够尽可能快的在大多数节点对一轮远程调用作出相应时完成，少部分慢的机器不会影响系统的整体性能。</li>
</ol>
<h3 id="Leader选举"><a href="#Leader选举" class="headerlink" title="Leader选举"></a>Leader选举</h3><h4 id="节点状态"><a href="#节点状态" class="headerlink" title="节点状态"></a>节点状态</h4><p>Raft协议中的每个节点都会处于三种状态之一：Leader、Follower、Candidate。</p>
<ol>
<li>Leader(领导者)：所有的请求都会被发送给Leader进行处理，然后同步到集群的其他节点中</li>
<li>Follower(追随者)：从Leader节点接受更新请求，然后写入本地的Log中</li>
<li>Candidate(候选者)：如果Follower在一段时间内没有收到Leader的心跳，则判断Leader可能已经故障，此时启动选主过程，此时节点会变成Candidate状态，直到选主结束。</li>
</ol>
<h4 id="Term机制"><a href="#Term机制" class="headerlink" title="Term机制"></a>Term机制</h4><p>Raft算法将时间分为任意不同长度的Term(任期)，任期用连续的数字进行表示。每一个任期的开始都是一次选举（election），一个或多个候选人会试图成为领导人。如果一个候选人赢得了选举，它就会在该任期的剩余时间担任领导人。在某些情况下，选票会被瓜分，有可能没有选出领导人，那么，将会开始另一个任期，并且立刻开始下一次选举，Raft算法保证在给定的一个任期最少要有一个领导人。</p>
<p>在每个任期中，开始进行选举：</p>
<ol>
<li>Follower将自己维护的current_term_id加1。</li>
<li>然后将自己的状态转成Candidate</li>
<li>发送RequestVoteRPC消息(带上current_term_id)给其它所有server</li>
</ol>
<p>节点看到的选举结果有三种：</p>
<ol>
<li>自己成为了Leader,这样本身就会定期向其它节点发送无log信息的AppendEntriesRPC消息，其他节点收到rpc_term_id大于自身，即更新自己的current_term_id。如果当前state为leader或者candidate时，将自己的状态切成follower。</li>
<li>等待别人的选票时，有可能会收到来自其他节点发来的声明其为领导人的AppendEntriesRPC消息。如果这个领导人的任期比当前候选人的当前任期要大，则候选人认为该领导人合法，并且转换自己的状态为追随者。如果在这个RPC中的任期小于候选人的当前任期，则候选人会拒绝这条消息，继续保持候选人状态。</li>
<li>还有可能选票被分散，没有节点获得大多数票数，此时会current_term_id自增1重新进行选举。Raft使用随机的选举超时时间来确保第三种情形很少发生，并且能够快速解决。为了防止在一开始是选票就被瓜分，选举超时时间是在一个固定的间隔内随机选出来的（例如，150~300ms）。</li>
</ol>
<blockquote>
<p>注意：单节点故障的间隔时间 &gt;&gt;(远大于) 选举超时时间 &gt;&gt; 广播消息时间  </p>
</blockquote>
<h3 id="日志复制"><a href="#日志复制" class="headerlink" title="日志复制"></a>日志复制</h3><p>Leader被选举出来之后，就开始接收客户端的请求。领导人把这条命令作为新的日志条目加入到它的日志中去，然后并行的向其他服务器发起AppendEntriesRPC消息，要求其它节点复制这个条目。当这个条目被安全的复制之后，领导人会将这个条目应用到它的状态机中并且会向客户端返回执行结果。如果追随者崩溃了或者运行缓慢或者是网络丢包了，领导人会无限的重试AppendEntriesRPC消息（甚至在它向客户端响应之后）,直到所有的追随者最终存储了所有的日志条目。</p>
<p>当Leader想要将操作消息添加到Log中，需要确定当前消息是可提交的。所谓的可提交，即领导人创建的条目已经复制到了大多数的服务器。<br>判断Leader和Follower的Log一致的机制如下：Leader为每个Follower保存了一个nextIndex，它表示领导人将要发送给该追随者的下一条日志条目的索引。Leader开始时会将nextIndex初始化为它的最新的日志条目索引数+1。如果一个追随者的日志和领导者的不一致，AppendEntries一致性检查会在下一次AppendEntriesRPC消息时返回失败。在失败之后，领导人会将nextIndex递减然后重试。最终nextIndex会达到一个领导人和追随者日志一致的地方。这时，AppendEntries会返回成功，追随者中冲突的日志条目都被移除了，并且添加所缺少的上了领导人的日志条目。当AppendEntries消息返回成功，追随者和领导人的日志就一致了，这样的状态会保持到该任期结束。</p>
<p>论文给出了一些优化的方法来减少通讯的次数，这里不多介绍。</p>
<h3 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h3><p>前面已经说清楚Raft算法是如何进行领导选取和复制日志的。然而，到目前为止这个机制还不能保证每一个状态机能按照相同的顺序执行同样的指令。例如，当领导人提交了若干日志条目的同时一个追随者可能宕机了，之后它又被选为了领导人然后用新的日志条目覆盖掉了旧的那些，最后，不同的状态机可能执行不同的命令序列。</p>
<p>这里介绍论文里提的一个示例：</p>
<p><img src="images/A42174BC-D9D9-4752-9A4D-53914022E814.png" alt=""></p>
<ol>
<li>term为2，S1是Leader，且S1写入日志（term, index）为(2, 2)，并且日志被同步写入了S2；</li>
<li>S1失去连接，触发新的选举，此时S5被选为新的Leader，此时系统term为3，且写入了日志（term, index）为（3，2）;</li>
<li>S5还没有推送，发生掉线。触发了选举，之前离线的S1经过重新上线后被选中变成Leader，此时系统term为4，此时S1会将自己的日志同步到Followers，按照上图就是将日志（2， 2）同步到了S3，而此时由于该日志已经被同步到了多数节点（S1, S2, S3），因此，此时日志（2，2）可以被commit了（即更新到状态机）；</li>
<li>d阶段，S1下线，S5上线，又被选举为Leader，这样S5就将S2和S3的信息覆盖了,这样S1的状态机就和其他不一致了</li>
</ol>
<p>因此，raft添加了一个很简单的选举限制：<strong>只有Leader当前任期的日志条目才能通过计算数目来进行提交。</strong>。<br>针对上述情况就是：即使日志（2，2）已经被大多数节点（S1、S2、S3）确认了，但是它不能被Commit，因为它是来自之前term(2)的日志，直到S1在当前term（4）产生的日志（4，4）被大多数Follower确认，S1方可Commit（4，4）这条日志，当然，根据Raft定义，（4，4）之前的所有日志也会被Commit。此时即使S1再下线，重新选主时S5不可能成为Leader，因为它没有包含大多数节点已经拥有的日志（4，4）。</p>
<h3 id="集群变化"><a href="#集群变化" class="headerlink" title="集群变化"></a>集群变化</h3><p>为了让配置修改机制能够安全，那么在转换的过程中在任何时间点两个领导人不能再同一个任期被同时选为领导人。不幸的是，服务器集群从旧的配置直接升级到新的配置的任何方法都是不安全的，一次性自动的转换所有服务器是不可能的，所以集群可以在转换的过程中划分成两个单独的组(old 和 new)。</p>
<p><img src="images/4858d6a8ly1fccbvshy16j20f00a374x.jpg" alt=""></p>
<p>具体流程如下：</p>
<ol>
<li>Leader收到新的配置命令从old切换到new；</li>
<li>Leader生成新的Log消息，保存有old和new的消息，推送给其他节点。</li>
<li>一个服务器将新的配置日志条目增加到它的日志中，它就会用这个配置来做出未来所有的决定</li>
<li>当多数Follower确认收到日志，Leader即提交这条Log(如果Leader崩溃了，被选出来的新领导人可能是使用Cold配置也可能是Cold,new配置，这取决于赢得选举的候选人是否已经接收到了Cold,new配置。在任何情况下，Cnew配置在这一时期都不会单方面的做出决定。)</li>
<li>Leader再生成一条包含Cnew配置的log消息，同样将该log entry写入本地日志，同时推送到Follower上</li>
<li>新配置提交后，即可正常使用</li>
</ol>
<p>三个问题</p>
<ol>
<li>新节点没有Log信息，同步时间怎么办？<br>为了避免这种可用性的间隔时间，Raft在配置更新的时候使用了一种额外的阶段，在这个阶段，新节点以没有投票权的身份加入到集群中来（领导人复制日志给他们，但是不把它们考虑到大多数中）。</li>
<li>集群的领导人可能不是新配置的一员？<br>领导人就会在提交了Cnew日志之后退位（回到跟随者状态）。这意味着有这样的一段时间，领导人管理着集群，但是不包括自己；它复制日志但是不把它自己看作是大多数之一。当Cnew被提交时，会发生Leader过渡，因为这时是新的配置可以独立工作的最早的时间点</li>
<li>移除不在Cnew中的服务器可能会扰乱集群，比如多余的心跳消息等<br>为了避免这个问题，当服务器确认当前Leader存在时，服务器会忽略RequestVoteRPC消息。特别的，当服务器在当前最小选举超时时间内收到一个RequestVoteRPC，它不会更新当前的任期号或者投出选票。这不会影响正常的选举，每个服务器在开始一次选举之前，至少等待一个最小选举超时时间。然而，这有利于避免被移除的服务器扰乱：如果领导人能够发送心跳给集群，那么它就不会被更大的任期号废除。</li>
</ol>
<h3 id="快照技术"><a href="#快照技术" class="headerlink" title="快照技术"></a>快照技术</h3><p>由于不能让Log无限增长，因此定期对Commit的状态机进行快照。</p>
<p>#blog/一致性算法</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/23/python小计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Cheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/23/python小计/" itemprop="url">python小计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-23T14:35:48+08:00">2018-02-23</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>python作为一个非常方便的胶水语言，由于其便于上手，数学库全等优势在机器学习领域最近一直大热。<br>这一篇博客主要记录一下最近工作写了两个脚本，虽然只花了半天时间，但还是记录一下以便下次写相关东西能够更快。</p>
<h3 id="MD5加密"><a href="#MD5加密" class="headerlink" title="MD5加密"></a>MD5加密</h3><p>第一个主要是用于加密的相关方法，只是使用了一些hashlib的方法，没什么好说的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">dir = <span class="string">"D:\\Workspace\\DYGameH\\settings\\"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify</span><span class="params">(dir, salt)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    计算当前文件是否被修改</span></span><br><span class="line"><span class="string">    :param dir:文件夹路径</span></span><br><span class="line"><span class="string">    :param salt: 密钥</span></span><br><span class="line"><span class="string">    :return:验证结果</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    md5num = md5sum(dir, salt)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(dir + <span class="string">"verify"</span>):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"the verify file is not exist."</span>)</span><br><span class="line">    <span class="keyword">with</span> open(dir + <span class="string">"verify"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> file:</span><br><span class="line">        md5verify = file.read()</span><br><span class="line">    <span class="keyword">if</span> md5num.__eq__(md5verify):</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5sum_with_json</span><span class="params">(dir, salt)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    以json格式处理,转换成字符串进行md5加密</span></span><br><span class="line"><span class="string">    :param dir: 需要加密的json文件的文件夹路径</span></span><br><span class="line"><span class="string">    :param salt: 密钥</span></span><br><span class="line"><span class="string">    :return: md5值</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    m = hashlib.md5()</span><br><span class="line">    str = salt;</span><br><span class="line">    <span class="keyword">if</span> isinstance(dir, basestring) <span class="keyword">and</span> os.path.exists(dir):</span><br><span class="line">        files = os.listdir(dir)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"the file directory is error."</span>)</span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> files:</span><br><span class="line">        <span class="keyword">if</span> filename.endswith(<span class="string">".json"</span>):</span><br><span class="line">            <span class="keyword">with</span> open(dir + filename, <span class="string">"rb"</span>) <span class="keyword">as</span> fh:</span><br><span class="line">                body = fh.read()</span><br><span class="line">                decoded = json.loads(body)</span><br><span class="line">                data_str = json.dumps(decoded)</span><br><span class="line">                str += data_str</span><br><span class="line">                <span class="keyword">print</span> data_str</span><br><span class="line">                <span class="comment"># m.update(data_str)</span></span><br><span class="line">    m.update(str)</span><br><span class="line">    <span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5sum</span><span class="params">(dir, salt)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    计算文件的MD5值</span></span><br><span class="line"><span class="string">    :param dir: 需要加密的json文件的文件夹路径</span></span><br><span class="line"><span class="string">    :param salt: 密钥</span></span><br><span class="line"><span class="string">    :return: md5值</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 防止json文件过大，每次读取8KB</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_chunks</span><span class="params">(fh)</span>:</span></span><br><span class="line">        fh.seek(<span class="number">0</span>)</span><br><span class="line">        chunk = fh.read(<span class="number">8096</span>)</span><br><span class="line">        <span class="keyword">while</span> chunk:</span><br><span class="line">            <span class="keyword">yield</span> chunk</span><br><span class="line">            chunk = fh.read(<span class="number">8096</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            fh.seek(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    m = hashlib.md5()</span><br><span class="line">    m.update(salt)</span><br><span class="line">    <span class="keyword">if</span> isinstance(dir, basestring) <span class="keyword">and</span> os.path.exists(dir):</span><br><span class="line">        files = os.listdir(dir)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">"the file directory is error."</span>)</span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> files:</span><br><span class="line">        <span class="keyword">if</span> filename.endswith(<span class="string">".json"</span>):</span><br><span class="line">            <span class="keyword">with</span> open(dir + filename, <span class="string">"rb"</span>) <span class="keyword">as</span> fh:</span><br><span class="line">                <span class="keyword">for</span> chunk <span class="keyword">in</span> read_chunks(fh):</span><br><span class="line">                    m.update(chunk)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_to_verify</span><span class="params">(dir, m)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(dir, <span class="string">"wb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(m)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成verify文件</span></span><br><span class="line"><span class="comment"># write_to_verify(dir + "verify", md5sum(dir, "hello world"))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证verify文件与现有json文件计算的md5值比对</span></span><br><span class="line"><span class="comment"># print verify(dir, "hello world")</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pressure</span><span class="params">(v, t, n)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    compute sth.</span></span><br><span class="line"><span class="string">    :param v: </span></span><br><span class="line"><span class="string">    :param t: </span></span><br><span class="line"><span class="string">    :param n: </span></span><br><span class="line"><span class="string">    :return: </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    k = <span class="number">1.38e-23</span></span><br><span class="line">    <span class="keyword">return</span> n * t *k / v</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span> :</span><br><span class="line">    <span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">"verify"</span>:</span><br><span class="line">        write_to_verify(dir + <span class="string">"..\\verify"</span>, md5sum_with_json(dir, sys.argv[<span class="number">2</span>]))</span><br></pre></td></tr></table></figure>
<h3 id="爬虫"><a href="#爬虫" class="headerlink" title="爬虫"></a>爬虫</h3><p>这个爬虫主要用于论坛的奖励方法，主要用到了以下库：</p>
<ul>
<li>urllib2 : 用于获取网页信息，和curl差不多吧(大概是?)</li>
<li>csv : 为了给游戏策划更方便阅读,发现python有直接转化为csv格式的库</li>
<li>bs4 : 这个东西相比写正则表达式，方便太多了，贴上<a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/" target="_blank" rel="noopener">文档</a></li>
</ul>
<p>还有其他一些转码，设置header的等，可以直接拿来用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">hds=[&#123;<span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.1.6) Gecko/20091201 Firefox/3.5.6'</span>&#125;,\</span><br><span class="line">&#123;<span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Windows NT 6.2) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.12 Safari/535.11'</span>&#125;,\</span><br><span class="line">&#123;<span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)'</span>&#125;]</span><br><span class="line"></span><br><span class="line">idList = []</span><br><span class="line">contextList = []</span><br><span class="line">louList = []</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_list</span><span class="params">(num)</span>:</span></span><br><span class="line">   url_pre = <span class="string">'https://www.taptap.com/topic/2433648?page='</span></span><br><span class="line">   url_end = <span class="string">'#postsList'</span></span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, num+<span class="number">1</span>):</span><br><span class="line">       url = url_pre + str(i) + url_end</span><br><span class="line">       getContext(url)</span><br><span class="line">   csvFile = open(<span class="string">'./temp.csv'</span>, <span class="string">'w'</span>)</span><br><span class="line">   csvFile.write(codecs.BOM_UTF8)</span><br><span class="line">   writer = csv.writer(csvFile)</span><br><span class="line">   writer.writerow([<span class="string">'楼层'</span>, <span class="string">'名字'</span>, <span class="string">'内容'</span>])</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(idList)):</span><br><span class="line">       writer.writerow([louList[i], idList[i], contextList[i]])</span><br><span class="line">   csvFile.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getContext</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        req = urllib2.Request(url,headers=hds[<span class="number">0</span>])</span><br><span class="line">        source_code = urllib2.urlopen(req).read()</span><br><span class="line">        plain_text = str(source_code)</span><br><span class="line">        <span class="comment"># print(plain_text)</span></span><br><span class="line">    <span class="keyword">except</span> (urllib2.HTTPError, urllib2.URLError), e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line">    soup = BeautifulSoup(plain_text, <span class="string">"html.parser"</span>)</span><br><span class="line">    <span class="comment"># people_num = soup.find('div', &#123;'class': 'posts-item collapse in '&#125;).findAll('span')[1].string.strip()</span></span><br><span class="line">    <span class="keyword">for</span> id <span class="keyword">in</span> soup.find_all(<span class="string">'div'</span>, &#123;<span class="string">'class'</span>: <span class="string">'posts-item collapse in '</span>&#125;):</span><br><span class="line">        idList.append(id.get(<span class="string">"data-user"</span>))</span><br><span class="line">    <span class="keyword">for</span> text <span class="keyword">in</span> soup.find_all(<span class="string">'div'</span>, &#123;<span class="string">'class'</span>: <span class="string">'item-text-body bbcode-body'</span>&#125;):</span><br><span class="line">        contextList.append(text)</span><br><span class="line">    <span class="keyword">for</span> lou <span class="keyword">in</span> soup.find_all(<span class="string">'span'</span>, &#123;<span class="string">'class'</span> : <span class="string">'pull-right'</span>&#125;):</span><br><span class="line">        louList.append(lou.string)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    reload(sys)</span><br><span class="line">    sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br><span class="line">    get_list(<span class="number">23</span>)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/07/Go-Assembly实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Cheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/Go-Assembly实践/" itemprop="url">Go Assembly实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-07T14:40:23+08:00">2018-02-07</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Go-Assembly实践"><a href="#Go-Assembly实践" class="headerlink" title="Go Assembly实践"></a>Go Assembly实践</h1><p><a href="http://colobu.com/goasm/" target="_blank" rel="noopener">源地址</a></p>
<h3 id="符号列表与操作符"><a href="#符号列表与操作符" class="headerlink" title="符号列表与操作符"></a>符号列表与操作符</h3><ul>
<li>SB static basic pointer 全局符号</li>
<li>FP frame pointer 参数和本地变量</li>
<li>SP stack pointer 栈顶</li>
<li>MOVQ 移动变量，这里q表示QUADWORD</li>
<li>ADDQ 对值做加法，结果存入后者</li>
<li>LEAQ load effective address</li>
<li>GLOBL 全局变量</li>
<li>RET 返回</li>
<li>DATA 变量声明</li>
<li>CALL 调用函数接口</li>
</ul>
<h3 id="入门案例：Add"><a href="#入门案例：Add" class="headerlink" title="入门案例：Add"></a>入门案例：<code>Add</code></h3><p>在一个文件夹下创建两个文件<code>main.go</code>和<code>add.s</code></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(x, y <span class="keyword">int64</span>)</span> <span class="title">int64</span>	//函数声明</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(add(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TEXT ·add(SB),$<span class="number">0</span><span class="number">-24</span>	<span class="comment">//函数格式： TEXT package_name·func_name(SB),$frame_size(帧空间大小)-arg_size(参数和返回值的大小)</span></span><br><span class="line">    MOVQ x+<span class="number">0</span>(FP), BX	<span class="comment">//通过FP可以通过位移拿到相关参数，存到BX寄存器中</span></span><br><span class="line">    MOVQ y+<span class="number">8</span>(FP), BP	<span class="comment">//同上，拿到第二个变量</span></span><br><span class="line">    ADDQ BP, BX		<span class="comment">//计算</span></span><br><span class="line">    MOVQ BX, ret+<span class="number">16</span>(FP)	<span class="comment">//通过ret位移，存入变量</span></span><br><span class="line">    RET					<span class="comment">//注意RET之后要留一行，不然编译不过</span></span><br></pre></td></tr></table></figure>
<p>然后编译一下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> go build -gcflags "-l"</span><br><span class="line"><span class="meta">$</span> ./main</span><br><span class="line">5</span><br><span class="line"><span class="meta">$</span> go tool objdump -s "main\.add" main</span><br><span class="line">  add.s:2		0x1093750		488b5c2408		MOVQ 0x8(SP), BX</span><br><span class="line">  add.s:3		0x1093755		488b6c2410		MOVQ 0x10(SP), BP</span><br><span class="line">  add.s:4		0x109375a		4801eb			ADDQ BP, BX</span><br><span class="line">  add.s:5		0x109375d		48895c2418		MOVQ BX, 0x18(SP)</span><br><span class="line">  add.s:6		0x1093762		c3			RET</span><br></pre></td></tr></table></figure></p>
<h3 id="函数调用与String使用：Hello-world"><a href="#函数调用与String使用：Hello-world" class="headerlink" title="函数调用与String使用：Hello world"></a>函数调用与String使用：<code>Hello world</code></h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> _ <span class="string">"fmt"</span>	<span class="comment">//下划线避免 unusued package 编译错误.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    hello()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//helloworld.s</span></span><br><span class="line">#include <span class="string">"textflag.h"</span></span><br><span class="line"></span><br><span class="line">DATA world&lt;&gt;+<span class="number">0</span>(SB)/<span class="number">8</span>, $<span class="string">"hello wo"</span>	<span class="comment">//&lt;&gt;表示只在当前文件可用，相当于C的static，/8表示8个字节</span></span><br><span class="line">DATA world&lt;&gt;+<span class="number">8</span>(SB)/<span class="number">4</span>, $<span class="string">"rld "</span></span><br><span class="line"></span><br><span class="line">GLOBL world&lt;&gt;+<span class="number">0</span>(SB), RODATA, $<span class="number">12</span>	<span class="comment">//global变量，RODATA只读变量，长度为12</span></span><br><span class="line"></span><br><span class="line">TEXT ·hello(SB),$<span class="number">88</span><span class="number">-0</span></span><br><span class="line">    SUBQ $<span class="number">88</span>, SP		<span class="comment">//将SP指针挪到帧地址的开始位置</span></span><br><span class="line">    MOVQ BP, <span class="number">80</span>(SP)</span><br><span class="line">    LEAQ <span class="number">80</span>(SP), BP</span><br><span class="line"></span><br><span class="line">    LEAQ world&lt;&gt;+<span class="number">0</span>(SB), AX	<span class="comment">//加载字符串</span></span><br><span class="line">    MOVQ	 AX, my_string+<span class="number">48</span>(SP)</span><br><span class="line">    MOVQ	 $<span class="number">11</span>, my_string+<span class="number">56</span>(SP)</span><br><span class="line">    MOVQ	 $<span class="number">0</span>, autotmp_0+<span class="number">64</span>(SP)</span><br><span class="line">    MOVQ	 $<span class="number">0</span>, autotmp_0+<span class="number">72</span>(SP)</span><br><span class="line">    LEAQ	 <span class="keyword">type</span>·<span class="keyword">string</span>(SB), AX</span><br><span class="line">    MOVQ	 AX, (SP)</span><br><span class="line">    LEAQ	 my_string+<span class="number">48</span>(SP), AX</span><br><span class="line">    MOVQ	 AX, <span class="number">8</span>(SP)</span><br><span class="line"></span><br><span class="line">    CALL	 runtime·convT2E(SB)</span><br><span class="line">    MOVQ	 <span class="number">24</span>(SP), AX</span><br><span class="line">    MOVQ	 <span class="number">16</span>(SP), CX</span><br><span class="line">    MOVQ	 CX, autotmp_0+<span class="number">64</span>(SP)</span><br><span class="line">    MOVQ	 AX, autotmp_0+<span class="number">72</span>(SP)</span><br><span class="line">    LEAQ	 autotmp_0+<span class="number">64</span>(SP), AX</span><br><span class="line">    MOVQ	 AX, (SP)</span><br><span class="line">    MOVQ	 $<span class="number">1</span>, <span class="number">8</span>(SP)</span><br><span class="line">    MOVQ	 $<span class="number">1</span>, <span class="number">16</span>(SP)</span><br><span class="line"></span><br><span class="line">    CALL fmt·Println(SB)</span><br><span class="line"></span><br><span class="line">    MOVQ <span class="number">80</span>(SP), BP</span><br><span class="line">    ADDQ $<span class="number">88</span>, SP	<span class="comment">//恢复SP BP</span></span><br><span class="line">    RET</span><br></pre></td></tr></table></figure>
<p>代码相当的复杂， 教训就是尽量不要在go汇编中调用函数。<br>一般来说，go源代码的实现远没有这么复杂，接着看几个例子学习一下：</p>
<h4 id="asin"><a href="#asin" class="headerlink" title="asin"></a>asin</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Asin</span><span class="params">(x <span class="keyword">float64</span>)</span> <span class="title">float64</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">main</span> <span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(Asin(<span class="number">1</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//asin.s</span></span><br><span class="line">#include <span class="string">"textflag.h"</span>		<span class="comment">//为了使用NOSPLIT，用于告诉编译器不需要栈扩展</span></span><br><span class="line"></span><br><span class="line">TEXT ·Asin(SB),NOSPLIT,$<span class="number">0</span><span class="number">-16</span></span><br><span class="line">    FMOVD x+<span class="number">0</span>(FP), F0		<span class="comment">//使用FPU寄存器FP，FMOVD设置F0和F1的值为函数的输入参数x</span></span><br><span class="line">    FMOVD F0, F1</span><br><span class="line">    FMULD F0, F0			<span class="comment">//F0=x*x, F1=x</span></span><br><span class="line">    FLD1						<span class="comment">//FLD1将+1.0压入FPU的栈，结果导致F0=1,F1=F0和F2=F1。F0=1, F1=x*x, F2=x</span></span><br><span class="line"></span><br><span class="line">    FSUBRDP F0, F1			<span class="comment">//FSUBRDP将F0减去F1的值，存储在F1中，然后从FPU栈中弹出栈顶，结果使 F0 = F1, F1 = F2 和 F2 = NaN。也就是 F0 = 1-x*x 和 F1 = x.</span></span><br><span class="line">    FSQRT					<span class="comment">//FSQRT计算F0的平方根 ，结果存储在F0</span></span><br><span class="line">    FPATAN					<span class="comment">//FPATAN指令计算 arctan(F1/F0), 弹出FPU栈顶，计算结果放入到F0，F1为NaN。其实就是利用公式arctan(x/sqrt(1-x*x))计算arcsin(x)的值</span></span><br><span class="line"></span><br><span class="line">    FMOVDP  F0, ret+<span class="number">8</span>(FP)</span><br><span class="line">    RET</span><br></pre></td></tr></table></figure>
<h4 id="sync-Atomic"><a href="#sync-Atomic" class="headerlink" title="sync.Atomic"></a>sync.Atomic</h4><p>这个例子摘自<a href="https://golang.org/pkg/sync/atomic/" target="_blank" rel="noopener">sync.Atomic</a>, 提供了底层的原子操作.SwapT函数实现了swap操作。</p>
<ol>
<li>old = *addr </li>
<li>*addr = new</li>
<li>return old</li>
</ol>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> atomic</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SwapInt32</span><span class="params">(addr *<span class="keyword">int32</span>, <span class="built_in">new</span> <span class="keyword">int32</span>)</span> <span class="params">(old <span class="keyword">int32</span>)</span> //<span class="title">SwapInt32</span> 自动保存新值到 *<span class="title">addr</span> 并且返回先前的 *<span class="title">addr</span> 的值.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">***</span></span><br><span class="line"><span class="function">#<span class="title">include</span> "<span class="title">textflag</span>.<span class="title">h</span>"</span></span><br><span class="line"><span class="function"><span class="title">TEXT</span> ·<span class="title">SwapInt32</span><span class="params">(SB)</span>,<span class="title">NOSPLIT</span>,$0-20</span></span><br><span class="line"><span class="function">		<span class="title">JMP</span> ·<span class="title">SwapUint32</span><span class="params">(SB)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">TEXT</span> ·<span class="title">SwapUint32</span><span class="params">(SB)</span>,<span class="title">NOSPLIT</span>,$0-20</span></span><br><span class="line"><span class="function">		<span class="title">MOVQ</span>	<span class="title">addr</span>+0<span class="params">(FP)</span>, <span class="title">BP</span></span></span><br><span class="line"><span class="function">		<span class="title">MOVL</span>	<span class="title">new</span>+8<span class="params">(FP)</span>, <span class="title">AX</span></span></span><br><span class="line"><span class="function">		<span class="title">XCHGL</span>	<span class="title">AX</span>, 0<span class="params">(BP)</span>		//<span class="title">XCHGL</span> 并不等价于 <span class="title">Write</span>-<span class="title">After</span>-<span class="title">Read</span>, 因为在数据交换的时候总线是加锁的</span></span><br><span class="line"><span class="function">		<span class="title">MOVL</span>	<span class="title">AX</span>, <span class="title">old</span>+16<span class="params">(FP)</span></span></span><br><span class="line"><span class="function">		<span class="title">RET</span></span></span><br></pre></td></tr></table></figure>
<h4 id="获取goroutineid"><a href="#获取goroutineid" class="headerlink" title="获取goroutineid"></a>获取goroutineid</h4><p>演示了如何访问runtime内部的数据结构。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +build amd64 amd64p32</span></span><br><span class="line"><span class="comment">// +build go1.5</span></span><br><span class="line">#include <span class="string">"go_asm.h"</span></span><br><span class="line">#include <span class="string">"textflag.h"</span></span><br><span class="line"></span><br><span class="line">TEXT ·Get(SB),NOSPLIT,$<span class="number">0</span><span class="number">-8</span>	<span class="comment">//函数 Get() int64的实现</span></span><br><span class="line">MOVQ (TLS), R14			<span class="comment">//TLS其实是线程本地存储（Thread Local Storage ）的缩写。在Go语言中，TLS存储了一个G结构体的指针。也可以使用宏get_tls(R14)来实现。下面的指令其实是将g的指针放入 R14 寄存器</span></span><br><span class="line">MOVQ g_goid(R14), R13		<span class="comment">//利用宏g_goid获取goroutine的id,并将结果存入到寄存器R13</span></span><br><span class="line">MOVQ R13, ret+<span class="number">0</span>(FP)		<span class="comment">//将结果返回</span></span><br><span class="line">RET</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/02/译-Unsafe-Pointer和系统调用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Cheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/02/译-Unsafe-Pointer和系统调用/" itemprop="url">[译]Unsafe.Pointer和系统调用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-02T14:49:54+08:00">2018-02-02</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="unsafe-Pointer和系统调用"><a href="#unsafe-Pointer和系统调用" class="headerlink" title="unsafe.Pointer和系统调用"></a>unsafe.Pointer和系统调用</h1><p><code>unsafe.Pointer</code>类型允许你绕过Go的类型系统，支持任意类型与内置<code>uintptr</code>对其类型之间的转换。根据文档，该包提供了4个操作用于类型装换：</p>
<ol>
<li>任何类型的指针都可以转换为<code>unsafe.Pointer</code>类型</li>
<li>一个<code>unsafe.Pointer</code>可以被转换成任何类型的指针</li>
<li>一个<code>uintptr</code>类型可以转换成一个<code>unsafe.Pointer</code>类型</li>
<li>一个<code>unsafe.Pointer</code>类型可以转换成一个<code>uintptr</code>类型</li>
</ol>
<p>这提供了两个只有在该包下才能使用的操作方法：使用<code>unsafe.Pointer</code>对任意两个类型进行类型转换；进行系统调用。</p>
<h2 id="使用unsafe-Pointer进行类型转换"><a href="#使用unsafe-Pointer进行类型转换" class="headerlink" title="使用unsafe.Pointer进行类型转换"></a>使用<code>unsafe.Pointer</code>进行类型转换</h2><p>最典型的例子就是<code>math.Float64bits</code>的实现：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Float64bits</span><span class="params">(f <span class="keyword">float64</span>)</span> <span class="title">uint64</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> *(*<span class="keyword">uint64</span>)(unsafe.Pointer(&amp;f))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体步骤如下：</p>
<ol>
<li>通过<code>&amp;f</code>获取<code>f</code>存储位置的指针</li>
<li><code>unsafe.Pointer(&amp;f)</code>将<code>*float64</code>转化为<code>unsafe.Pointer</code></li>
<li><code>(*uint64)(unsafe.Pointer(&amp;f))</code>将<code>unsafe.Pointer</code>转化为<code>*uint64</code></li>
<li><code>*(*uint64)(unsafe.Pointer(&amp;f))</code>解除引用，返回<code>uint64</code>类型的值</li>
</ol>
<p>将上例细化就是如下：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Float64bits</span><span class="params">(floatVal <span class="keyword">float64</span>)</span> <span class="title">uint64</span></span> &#123;</span><br><span class="line">	<span class="comment">// Take a pointer to the float64 value stored in f.</span></span><br><span class="line">	floatPtr := &amp;floatVal</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Convert the *float64 to an unsafe.Pointer.</span></span><br><span class="line">	unsafePtr := unsafe.Pointer(floatPtr)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Convert the unsafe.Pointer to *uint64.</span></span><br><span class="line">	uintPtr := (*<span class="keyword">uint64</span>)(unsafePtr)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Dereference the *uint64, yielding a uint64 value.</span></span><br><span class="line">	uintVal := *uintPtr</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> uintVal</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这很好用，下面举个例子：</p>
<h3 id="真正的案例：taskstats"><a href="#真正的案例：taskstats" class="headerlink" title="真正的案例：taskstats"></a>真正的案例：taskstats</h3><p>我最近正在研究Linux的taskstats接口，我想要用一种方法来检索Go中的内核里面C的taskstats结构。在发送一个CL将结构发送到<code>x/sys/unix</code>之后，我意识到这个结构实际上有多大和多么复杂。<br>为了使用这个结构，我需要精心地从字节slice中解析每个字段。更复杂的事情是，每个整数类型都以“本地”字节顺序存储，因此根据CPU，整数可能会以不同的格式存储在内存中。</p>
<p>这个任务非常适合使用<code>unsafe.Pointer</code>来进行转换，这是我写的：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Verify that the byte slice containing a unix.Taskstats is the</span></span><br><span class="line"><span class="comment">// size expected by this package, so we don't blindly cast the</span></span><br><span class="line"><span class="comment">// byte slice into a structure of the wrong size.</span></span><br><span class="line"><span class="keyword">const</span> sizeofTaskstats = <span class="keyword">int</span>(unsafe.Sizeof(unix.Taskstats&#123;&#125;))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> want, got := sizeofTaskstats, <span class="built_in">len</span>(buf); want != got &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unexpected taskstats structure size, want %d, got %d"</span>, want, got)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stats := *(*unix.Taskstats)(unsafe.Pointer(&amp;buf[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure></p>
<p>如果你熟悉slice的内部结构，你会知道一个slice实际上是一个包含了头和一个指向底层数组的指针。在使用<code>unsafe.Pointer</code>转换slice数据时，必须指定数组第一个元素的内存地址，而不是头部本身。<br>使用<code>unsafe.Pointer</code>使得转换非常简洁和简单。由于整数数据存储与我们的CPU相同的排序，使用<code>unsafe.Pointer</code>转换意味着其整数值将是我们所期望的。</p>
<h2 id="使用unsafe-Pointer进行系统调用"><a href="#使用unsafe-Pointer进行系统调用" class="headerlink" title="使用unsafe.Pointer进行系统调用"></a>使用<code>unsafe.Pointer</code>进行系统调用</h2><p>在处理系统调用时，有时需要将指向某个内存的指针传递给内核以允许其执行某个任务。这是<code>unsafe.Pointer</code>的另一个重要用例。在使用系统调用时，必须使用<code>unsafe.Pointer</code>，因为它可以转换为<code>uintptr</code>来被<code>syscall.Syscall</code>函数一起使用。</p>
<p>对于许多不同的操作系统有大量的系统调用，但是对于这个例子，我们将关注于<code>ioctl</code>。在类UNIX系统中，<code>ioctl</code>通常用于对文件描述符执行操作，这些操作不会仅仅映射到典型的文件系统操作，如读写。实际上，由于其巨大的灵活性，在Go的<code>syscall</code>或<code>x/sys/unix</code>软件包中不存在裸露的<code>ioctl</code>系统调用。</p>
<p>过去几年，<code>Linux</code>提供了一个新的socket簇<code>AF_VSOCK</code>,用于支持管理程序与多个虚拟机之间能够进行双向的一对多通信。<br>这些套接字使用上下文ID进行通信，可以通过向<code>/dev/vsock</code>发送带有特殊请求编号的<code>ioctl</code>来检索上下文标识。</p>
<p>以下是<code>ioctl</code>函数的定义：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Ioctl</span><span class="params">(fd <span class="keyword">uintptr</span>, request <span class="keyword">int</span>, argp unsafe.Pointer)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	_, _, errno := unix.Syscall(</span><br><span class="line">		unix.SYS_IOCTL,</span><br><span class="line">		fd,</span><br><span class="line">		<span class="keyword">uintptr</span>(request),</span><br><span class="line">		<span class="comment">// Note that the conversion from unsafe.Pointer to uintptr _must_</span></span><br><span class="line">		<span class="comment">// occur in the call expression.  See the package unsafe documentation</span></span><br><span class="line">		<span class="comment">// for more details.</span></span><br><span class="line">		<span class="keyword">uintptr</span>(argp),</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> errno != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> os.NewSyscallError(<span class="string">"ioctl"</span>, fmt.Errorf(<span class="string">"%d"</span>, <span class="keyword">int</span>(errno)))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如注释所指，这里使用<code>unsafe.Pointer</code>有一个重要的警告:</p>
<blockquote>
<p><code>syscall</code>包中的<code>Syscall</code>函数直接将它们的<code>uintptr</code>参数传递给操作系统，然后根据调用的细节将其中的一些重新解释为指针。也就是说，系统调用实现是隐式地将某些参数从uintptr转换回指针。<br>如果必须将指针参数转换为uintptr以用作参数，则该转换必须出现在调用表达式本身中。</p>
</blockquote>
<p>但是为什么这样呢？这是编译器识别的特殊模式，它主要指示垃圾收集器在函数调用完成之前不要重新排列指针引用的内存。<br>您可以阅读文档以获取更多技术细节，但在Go中使用系统调用时，您必须始终记住此规则。事实上，当我编写这篇文章时，我意识到我的代码在技术上违反了这个规则！这现在已经修复了。<br>考虑到这一点，我们可以看到这个功能是如何使用的。<br>在VM Socket的情况下，我们想要将一个<code>*uint32</code>传递给内核，以便它可以用我们的本地上下文ID填充那个内存地址的值。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">f, err := fs.Open(<span class="string">"/dev/vsock"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Context ID is populated by Ioctl.</span></span><br><span class="line"><span class="keyword">var</span> cid <span class="keyword">uint32</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Retrieve the context ID of this machine from /dev/vsock.</span></span><br><span class="line">err = Ioctl(f.Fd(), unix.IOCTL_VM_SOCKETS_GET_LOCAL_CID, unsafe.Pointer(&amp;cid))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Return the now-populated context ID to the caller.</span></span><br><span class="line"><span class="keyword">return</span> cid, <span class="literal">nil</span></span><br></pre></td></tr></table></figure>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>虽然使用不安全包装可能充满了危险，但如果使用得当，它可能是一个非常强大和有用的工具。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/31/译-Go的Stream-IO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Cheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/31/译-Go的Stream-IO/" itemprop="url">[译]Go的Stream IO</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-31T14:51:18+08:00">2018-01-31</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="译-Go的Stream-IO"><a href="#译-Go的Stream-IO" class="headerlink" title="[译]Go的Stream IO"></a>[译]Go的Stream IO</h1><p>在Go中，输入和输出操作是将数据建模为可以读取或写入的字节流的原语实现的。为了做到这一点，Go的io包提供了接口<code>io.Reader</code>和<code>io.Writer</code>，分别用于数据输入和输出操作，如下图所示：</p>
<p><img src="images/1_0HHGvzhDxcFpefBJZOu-Tg.png" alt=""></p>
<p>Go提供了很多支持流式IO的API，包括内存数据，文件，网络连接等。本文关注于创建支持流式传输的Go程序，通过自定义和标准库API使用<code>io.Reader</code>和<code>io.Writer</code>来完成。</p>
<h2 id="io-Reader"><a href="#io-Reader" class="headerlink" title="io.Reader"></a>io.Reader</h2><p>一个表示<code>io.Reader</code>接口的Reader可以从某个源读取数据到一个可以流式传输与使用的传送缓冲区(Transfer Buffer)，如下所示：<br><img src="images/88F6D824-70D8-4AFF-81E2-FDC64E2C69C7.png" alt=""><br>一个具有<code>Reader</code>功能的类型，需要实现<code>Read(p []byte)</code>方法：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">    Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)	<span class="comment">//实现的Read方法需要返回读取的byte数量和一个错误(如果有)，如果源数据读取结束了，返回io.EOF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="从reader中读取数据"><a href="#从reader中读取数据" class="headerlink" title="从reader中读取数据"></a>从reader中读取数据</h3><p>从一个reader中读取流失数据很容易，Read方法被设计可以循环使用，在每次循环中，它从数据源读取数据并将其放入缓冲区p中。该循环将继续直到该方法返回一个io.EOF错误。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	reader := strings.NewReader(<span class="string">"Clear is better than clever"</span>)</span><br><span class="line">	p := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">4</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		n, err := reader.Read(p)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">				fmt.Println(<span class="keyword">string</span>(p[:n])) <span class="comment">//should handle any remainding bytes.</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="keyword">string</span>(p[:n]))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">Clea</span></span><br><span class="line"><span class="comment">r is</span></span><br><span class="line"><span class="comment"> bet</span></span><br><span class="line"><span class="comment">ter </span></span><br><span class="line"><span class="comment">than</span></span><br><span class="line"><span class="comment"> cle</span></span><br><span class="line"><span class="comment">ver</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p>
<p>以上代码创建了一个4byte的传送缓冲区(<code>p := make([]byte, 4)</code>)。缓冲区有目的地使用小于字符串源的长度,这是为了演示如何从大于缓冲区的数据源中正确流化数据块。</p>
<h3 id="读取规则"><a href="#读取规则" class="headerlink" title="读取规则"></a>读取规则</h3><ol>
<li><code>Read</code>读取<code>len(p)</code>长度的字符串到<code>p</code>中</li>
<li>调用<code>Read</code>之后，<code>n</code>可能小于<code>len(p)</code></li>
<li>一旦出错，<code>Read</code>仍然可能会在缓冲区<code>p</code>中返回<code>n</code>个字节，例如，从突然关闭的TCP套接字读取数据。根据您的使用情况，您可以选择保存p中的数据或重试。</li>
<li>当<code>Read</code>耗尽可用数据时，读取器可能会返回一个非空的错误<code>io.EOF</code>。根据实现，Reader可以选择在流结束时返回非零的n和为空的err。在这种情况下，任何后续读取都必须返回<code>n = 0，err = io.EOF</code>。</li>
<li>最后，返回<code>n = 0</code>和<code>err = nil</code>的<code>Read</code>调用并不意味着EOF，因为下一次调用Read（）可能会返回更多的数据。</li>
</ol>
<p>正如你所看到的，正确地从Reader中读取流数据可能会很棘手。幸运的是，标准库中的Reader遵循了易于流式传输的方法。不过，在使用相关Reader之前，请查阅其文档。</p>
<h2 id="实现一个自定义的io-Reader"><a href="#实现一个自定义的io-Reader" class="headerlink" title="实现一个自定义的io.Reader"></a>实现一个自定义的io.Reader</h2><p>上一节使用标准库中的现有io.Reader实现。现在，让我们看看如何编写我们自己的实现。以下是io.Reader的一个简单实现，它能够从数据流中过滤出非字母字符。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AlphaReader <span class="keyword">struct</span> &#123;</span><br><span class="line">	src <span class="keyword">string</span></span><br><span class="line">	cur <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newAlphaReader</span><span class="params">(src <span class="keyword">string</span>)</span> *<span class="title">AlphaReader</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;AlphaReader&#123;src: src&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">alpha</span><span class="params">(r <span class="keyword">byte</span>)</span> <span class="title">byte</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (r &gt;= <span class="string">'A'</span> &amp;&amp; r &lt;= <span class="string">'Z'</span>) || (r &gt;= <span class="string">'a'</span> &amp;&amp; r &lt;= <span class="string">'z'</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> r</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *AlphaReader)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> a.cur &gt;= <span class="built_in">len</span>(a.src) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	x := <span class="built_in">len</span>(a.src) - a.cur</span><br><span class="line">	n, bound := <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">if</span> x &gt;= <span class="built_in">len</span>(p) &#123;</span><br><span class="line">		bound = <span class="built_in">len</span>(p)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		bound = x</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, bound)</span><br><span class="line">	<span class="keyword">for</span> n &lt; bound &#123;</span><br><span class="line">		<span class="keyword">if</span> char := alpha(a.src[a.cur]); char != <span class="number">0</span> &#123;</span><br><span class="line">			buf[n] = char</span><br><span class="line">		&#125;</span><br><span class="line">		n++</span><br><span class="line">		a.cur++</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">copy</span>(p, buf)</span><br><span class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	reader := newAlphaReader(<span class="string">"Hello! It's 9am, where is the sun?"</span>)</span><br><span class="line">	p := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">4</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		n, err := reader.Read(p)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">				fmt.Print(<span class="keyword">string</span>(p[:n])) <span class="comment">//should handle any remainding bytes.</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Print(<span class="keyword">string</span>(p[:n]))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="链接Reader"><a href="#链接Reader" class="headerlink" title="链接Reader"></a>链接Reader</h2><p>标准库有许多已经实现的Reader。使用Reader作为另一位Reader的数据源是一个常见的习惯用法。Reader的链接允许一个Reader重用另一个Reader的逻辑，就像下面的源代码片段中所做的那样，这个片段更新了alphaReader来接受一个io.Reader作为它的数据源。这可以通过将流量管理问题推给根读取器来降低代码的复杂性。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AlphaReader <span class="keyword">struct</span> &#123;</span><br><span class="line">	src <span class="keyword">string</span></span><br><span class="line">	cur <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newAlphaReader</span><span class="params">(src <span class="keyword">string</span>)</span> *<span class="title">AlphaReader</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;AlphaReader&#123;src: src&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">alpha</span><span class="params">(r <span class="keyword">byte</span>)</span> <span class="title">byte</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (r &gt;= <span class="string">'A'</span> &amp;&amp; r &lt;= <span class="string">'Z'</span>) || (r &gt;= <span class="string">'a'</span> &amp;&amp; r &lt;= <span class="string">'z'</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> r</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *AlphaReader)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> a.cur &gt;= <span class="built_in">len</span>(a.src) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	x := <span class="built_in">len</span>(a.src) - a.cur</span><br><span class="line">	n, bound := <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">	<span class="keyword">if</span> x &gt;= <span class="built_in">len</span>(p) &#123;</span><br><span class="line">		bound = <span class="built_in">len</span>(p)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		bound = x</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, bound)</span><br><span class="line">	<span class="keyword">for</span> n &lt; bound &#123;</span><br><span class="line">		<span class="keyword">if</span> char := alpha(a.src[a.cur]); char != <span class="number">0</span> &#123;</span><br><span class="line">			buf[n] = char</span><br><span class="line">		&#125;</span><br><span class="line">		n++</span><br><span class="line">		a.cur++</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">copy</span>(p, buf)</span><br><span class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	reader := newAlphaReader(<span class="string">"Hello! It's 9am, where is the sun?"</span>)</span><br><span class="line">	p := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">4</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		n, err := reader.Read(p)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">				fmt.Print(<span class="keyword">string</span>(p[:n])) <span class="comment">//should handle any remainding bytes.</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Print(<span class="keyword">string</span>(p[:n]))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="io-Writer"><a href="#io-Writer" class="headerlink" title="io.Writer"></a>io.Writer</h2><p>一个表示<code>io.Writer</code>接口的Writer可以读取buffer数据，并写入到某个数据源中，如下所示：</p>
<p><img src="images/5CCC609B-E017-4281-A6CD-5AD4F336564F.png" alt=""><br>所有的流Writer必须要实现<code>Write(p []byte)</code>方法，该方法设计用于读取buffer，并将其写入指定数据源：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">    Write(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="使用writer"><a href="#使用writer" class="headerlink" title="使用writer"></a>使用writer</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	proverbs := []<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"Channels orchestrate mutexes serialize"</span>,</span><br><span class="line">		<span class="string">"Cgo is not Go"</span>,</span><br><span class="line">		<span class="string">"Errors are values"</span>,</span><br><span class="line">		<span class="string">"Don't panic"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> writer bytes.Buffer</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, p := <span class="keyword">range</span> proverbs &#123;</span><br><span class="line">		n, err := writer.Write([]<span class="keyword">byte</span>(p))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> n != <span class="built_in">len</span>(p) &#123;</span><br><span class="line">			fmt.Println(<span class="string">"failed to write data"</span>)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(writer.String())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现自定义的Writer"><a href="#实现自定义的Writer" class="headerlink" title="实现自定义的Writer"></a>实现自定义的Writer</h2><p>这部分代码展示了如何实现一个自定义的Writer，能够将其写入Channel中。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> chanWriter <span class="keyword">struct</span> &#123;</span><br><span class="line">	ch <span class="keyword">chan</span> <span class="keyword">byte</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newChanWriter</span><span class="params">()</span> *<span class="title">chanWriter</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;chanWriter&#123;<span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">byte</span>, <span class="number">1024</span>)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *chanWriter)</span> <span class="title">Chan</span><span class="params">()</span> &lt;-<span class="title">chan</span> <span class="title">byte</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> w.ch</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *chanWriter)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	n := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> _, b := <span class="keyword">range</span> p &#123;</span><br><span class="line">		w.ch &lt;- b</span><br><span class="line">		n++</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *chanWriter)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="built_in">close</span>(w.ch)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	writer := newChanWriter()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> writer.Close()</span><br><span class="line">		writer.Write([]<span class="keyword">byte</span>(<span class="string">"Stream "</span>))</span><br><span class="line">		writer.Write([]<span class="keyword">byte</span>(<span class="string">"me!"</span>))</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">for</span> c := <span class="keyword">range</span> writer.Chan() &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%c"</span>, c)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="IO包中好用的类型和方法"><a href="#IO包中好用的类型和方法" class="headerlink" title="IO包中好用的类型和方法"></a>IO包中好用的类型和方法</h2><p>就像之前所说的，Go标准库提供了很多可用的方法来使用流式IO。</p>
<h3 id="os-File"><a href="#os-File" class="headerlink" title="os.File"></a>os.File</h3><p><code>os.File</code>表示本地系统的一个文件，它实现了<code>io.Write</code>和<code>io.Read</code>方法，因此可以用于任何流式IO的上下文。👇这个例子表示如何将字符串slice写入文件：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	proverbs := []<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"Channels orchestrate mutexes serialize\n"</span>,</span><br><span class="line">		<span class="string">"Cgo is not Go\n"</span>,</span><br><span class="line">		<span class="string">"Errors are values\n"</span>,</span><br><span class="line">		<span class="string">"Don't panic\n"</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	file, err := os.Create(<span class="string">"./proverbs.txt"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, p := <span class="keyword">range</span> proverbs &#123;</span><br><span class="line">		n, err := file.Write([]<span class="keyword">byte</span>(p))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> n != <span class="built_in">len</span>(p) &#123;</span><br><span class="line">			fmt.Println(<span class="string">"failed to write data"</span>)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">"file write done"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>相反，<code>io.File</code>也可用于读取文件内容，例如：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	file, err := os.Open(<span class="string">"./proverbs.txt"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">	p := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">4</span>)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		n, err := file.Read(p)</span><br><span class="line">		<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Print(<span class="keyword">string</span>(p[:n]))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="标准的output-input-and-error"><a href="#标准的output-input-and-error" class="headerlink" title="标准的output,input and error"></a>标准的<code>output</code>,<code>input</code> and <code>error</code></h3><p>os包提供了3个变量<code>os.Stdout</code>,<code>os.Stdin</code> and <code>os.Stderr</code>,均为<code>*os.File</code>类型，用于控制操作系统的标准输入，标准输出和标准报错。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">unc main() &#123;</span><br><span class="line">	proverbs := []<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"Channels orchestrate mutexes serialize\n"</span>,</span><br><span class="line">		<span class="string">"Cgo is not Go\n"</span>,</span><br><span class="line">		<span class="string">"Errors are values\n"</span>,</span><br><span class="line">		<span class="string">"Don't panic\n"</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, p := <span class="keyword">range</span> proverbs &#123;</span><br><span class="line">		n, err := os.Stdout.Write([]<span class="keyword">byte</span>(p))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> n != <span class="built_in">len</span>(p) &#123;</span><br><span class="line">			fmt.Println(<span class="string">"failed to write data"</span>)</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="io-Copy"><a href="#io-Copy" class="headerlink" title="io.Copy"></a>io.Copy</h3><p><code>io.Copy</code>提供了更方便将数据源写入目的地的方法。它抽象了<code>for</code>循环和<code>io.EOF</code>的判断等操作。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	proverbs := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">	proverbs.WriteString(<span class="string">"Channels orchestrate mutexes serialize\n"</span>)</span><br><span class="line">	proverbs.WriteString(<span class="string">"Cgo is not Go\n"</span>)</span><br><span class="line">	proverbs.WriteString(<span class="string">"Errors are values\n"</span>)</span><br><span class="line">	proverbs.WriteString(<span class="string">"Don't panic\n"</span>)</span><br><span class="line"></span><br><span class="line">	file, err := os.Create(<span class="string">"./proverbs.txt"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// copy from reader data into writer file</span></span><br><span class="line">	<span class="keyword">if</span> _, err := io.Copy(file, proverbs); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">"file created"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类似，我们可以重写之前将文件作为输入，输出到标准输出中的程序：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	file, err := os.Open(<span class="string">"./proverbs.txt"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> _, err := io.Copy(os.Stdout, file); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="io-WriteString"><a href="#io-WriteString" class="headerlink" title="io.WriteString"></a>io.WriteString</h3><p>此函数提供了将字符串写入指定writer的便利操作</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	file, err := os.Create(<span class="string">"./magic_msg.txt"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> file.Close()</span><br><span class="line">	<span class="keyword">if</span> _, err := io.WriteString(file, <span class="string">"Go is fun!"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="管道Reader和Writer"><a href="#管道Reader和Writer" class="headerlink" title="管道Reader和Writer"></a>管道Reader和Writer</h3><p><code>io.PipeWriter</code>和<code>io.PipeReader</code>类型在内存中进行管道的IO操作。将数据写入管道的写入端，并使用单独的routine在管道的Reader端读取数据。<br>下面使用<code>io.Pipe</code>创建管道Reader和Writer对，然后使用<code>io.Pipe</code>将数据从缓冲区复制到<code>io.Stdout</code>：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	proverbs := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">	proverbs.WriteString(<span class="string">"Channels orchestrate mutexes serialize\n"</span>)</span><br><span class="line">	proverbs.WriteString(<span class="string">"Cgo is not Go\n"</span>)</span><br><span class="line">	proverbs.WriteString(<span class="string">"Errors are values\n"</span>)</span><br><span class="line">	proverbs.WriteString(<span class="string">"Don't panic\n"</span>)</span><br><span class="line"></span><br><span class="line">	piper, pipew := io.Pipe()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// write in writer end of pipe</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> pipew.Close()</span><br><span class="line">		io.Copy(pipew, proverbs)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// read from reader end of pipe.</span></span><br><span class="line">	io.Copy(os.Stdout, piper)</span><br><span class="line">	piper.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Buffered-IO"><a href="#Buffered-IO" class="headerlink" title="Buffered IO"></a>Buffered IO</h3><p>Go通过软件包<code>bufio</code>支持缓冲IO，这使得使用文本内容变得更容易。<br>例如，下面的程序逐行读取一个文件的内容，用分号“\n”分隔：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	file, err := os.Open(<span class="string">"./planets.txt"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> file.Close()</span><br><span class="line">	reader := bufio.NewReader(file)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		line, err := reader.ReadString(<span class="string">'\n'</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				fmt.Println(err)</span><br><span class="line">				os.Exit(<span class="number">1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Print(line)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="util包"><a href="#util包" class="headerlink" title="util包"></a>util包</h3><p>ioutil包是io的一个子包，为IO提供了一些便利功能。例如，下面使用函数<code>ReadFile</code>将文件的内容加载到byte数组中：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">"io/ioutil"</span></span><br><span class="line">  <span class="string">"fmt"</span></span><br><span class="line">  <span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	bytes, err := ioutil.ReadFile(<span class="string">"./planets.txt"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">"%s"</span>, bytes)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>这篇文章展示了如何使用<code>io.Reader</code>和<code>io.Writer</code>接口在你的程序中实现流IO。读完这篇文章之后，你应该能够理解如何使用io包来创建为IO传输数据的程序。有很多的例子来展示了如何为自定义的功能创建自己的io.Reader和io.Writer类型。</p>
<p>这只是一个介绍性的讨论，几乎没有考虑支持流式IO的Go软件包的环境和范围。例如，我们没有设计文件IO，缓冲IO，网络IO或格式化的IO（保存用于将来的写入）。我希望这给你一个关于Go的流IO输入用法的可能性想法。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zhang Cheng</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate"> 
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang Cheng</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.6</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.6"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.6"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.6"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.6"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.6"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
